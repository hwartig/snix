"use strict";if(typeof window=="undefined")var _=require("underscore")._;var Snix={};(function(){if(typeof jQuery!="undefined"){var e=jQuery.cleanData;jQuery.cleanData=function(t){for(var n=0,r;(r=t[n])!==undefined;n++)jQuery(r).triggerHandler("destroyed");e(t)}}})(),Snix.idOf=function(e){return(typeof e=="string"||typeof e=="number"?e:Snix.unwrap(e.id)).toString()},Snix.call=function(e,t,n){var r=Snix.__caller__;Snix.__caller__=t,e.apply(n),Snix.__caller__=r},Snix.__caller__=null,Snix.unwrap=function(e){return e&&e.__snix__?this.unwrap(e()):e},function(){var e=function(t,n,r){r=r||[];if(t==null||_.include(r,t))return null;switch(typeof t){case"number":case"date":case"string":case"function":case"boolean":return t;case"object":r.push(t);if(t instanceof Array)for(var i=0;i<t.length;i++)t[i]=e(t[i],n,r);else for(var s in t){var o=t[s];delete t[s],t[n(s)]=e(o,n,r)}return t}};Snix.toCamelCase=function(t){return e(t,function(e){return e.replace(/(_[a-z])/g,function(e){return e.toUpperCase().replace("_","")})})},Snix.toUnderscore=function(t){return e(t,function(e){return e.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()})})}}(),Snix.useGC=!1,Snix.logGC=!1,Snix.objectCnt=0,Snix.Value=function(e){if(arguments.length==0||e===undefined)throw"missing valueProvider";var t=this,n=function(){if(!t.isDisposed){var e=t.dependants.length;t.dependants=_.reject(t.dependants,function(e){return e.isDisposed}),Snix.logGC&&t.dependants.length!=e&&console.info("snix gc["+t.id+"]: "+(e-t.dependants.length)),setTimeout(n,3e3)}};Snix.useGC&&setTimeout(n,3e3),this.id=_.uniqueId(),this.dependants=[],this.isValueAssigned=!1,this.value=null,this.valueProvider=e,this.isDisposed=!1,this.dispose=function(){this.isDisposed=!0,Snix.objectCnt--,_.each(this.dependants,function(e){e.isDisposed||e.dispose()}),this.dependants=[],this.dependants=null,this.isValueAssigned=null,this.value=null,this.valueProvider=null,this.get=function(){throw"disposed"},this.set=function(){throw"disposed"}},this.triggerDependants=function(){var e=[this],t=null;while(t=e.splice(0,1)[0]){t.dependants=_.reject(t.dependants,function(e){return e.isDisposed==1});for(var n=0;n<t.dependants.length;n++){var r=t.dependants[n];if(r==Snix.__caller__)continue;var i=r.valueProvider,s=i();s!==r.value&&(r.value=s,e.push(r))}}},this.convert=function(e){return e},this.set=function(e){e=this.convert(e),this.value!==e&&(this.value=e,this.isValueAssigned=!0,this.triggerDependants())},this.provideValue=function(){return typeof this.valueProvider=="function"?this.valueProvider():this.valueProvider},this.trackCaller=function(){Snix.__caller__&&(_.include(this.dependants,Snix.__caller__)||this.dependants.push(Snix.__caller__))},this.get=function(){return this.trackCaller(),this.isValueAssigned||(this.isValueAssigned=!0,this.set(this.provideValue())),this.value},this.fun=function(){var e=this,t=function(){return arguments.length==0?e.get():(e.set(arguments[0]),t)};t.__value__=this,t.dispose=function(){e.dispose.apply(e,arguments)},t.__snix__=!0,t.toJSON=function(){var t=e.get();return t&&t.toJSON?t.toJSON():t};var n=[];return t.subscribe=function(t,r){var i=Snix.compute(function(){var n=e.get();Snix.call(function(){t.apply(r,[n])},null,r)});return n.push([t,i]),i(),this},t.unsubscribe=function(e){var t=_.detect(n,function(t){return t[0]==e});return t[1].dispose(),n=_.without(n,t),this},Snix.objectCnt++,t}},Snix.Types={},Snix.Types.val=function(e){e=arguments.length>0?e:null;var t=new Snix.Value(e);return t.fun()},Snix.Types.boolean=function(e){var t=new Snix.Value(e);return t.convert=function(e){return e==null?null:e==1||e=="true"||e=="yes"},t.fun()},Snix.Types.int=function(e){var t=new Snix.Value(e);return t.convert=function(e){return e==null?null:parseInt(e,10)},t.fun()},Snix.Types.float=function(e){var t=new Snix.Value(e);return t.convert=function(e){return e==null?null:parseFloat(e)},t.fun()},Snix.Types.array=function(e){e=arguments.length>0?e:[];if(!_.isArray(e))throw"not an array";var t=new Snix.Value(e);t.convert=function(e){if(!_.isArray(e))throw"not an array";return e};var n=t.fun();return n.add=function(e){var n=t.get();n.push(e),t.triggerDependants()},n.remove=function(e){var n=t.get(),r=_.without(n,e);t.set(r)},n.size=function(){return t.get().length},n.clear=function(){t.set([])},n.isEmpty=function(){return t.get().length==0},n},Snix.Types.compute=function(e,t,n){t=t||this,n=_.defaults(n||{},{});var r=_.bind(e,t),i=function(){try{var e=Snix.__caller__;return Snix.__caller__=s,r()}finally{Snix.__caller__=e}},s=new Snix.Value(i);return s.fun()},Snix.Types.enu=function(){var e=[];for(var t=0;t<arguments.length;t++){var n={id:t,name:arguments[t].toString()};n.toJSON=function(){return this.name},n.toString=function(){return this.name},e.push(n)}var r=function(){if(arguments.length==0)return e;var t=_.where(e,{name:arguments[0].toString()})[0];if(!t)throw"unknown in enumeration: "+arguments[0].toString();return t};return r},Snix.Types.remote=function(e,t){var n=Snix.val(null);t=arguments.length>1?t:function(e){return e};var r=Snix.compute(function(){var r=typeof e=="function"?e():e;return r&&$.getJSON(r.toString()).success(function(e){n(t(e))}),r});return r(),n.reload=function(){n(null),r.__value__.isValueAssigned=!1,r()},n},Snix.Types.remoteArray=function(e,t){var n=Snix.array();t=arguments.length>1?t:function(e){return e};var r=Snix.compute(function(){var r=typeof e=="function"?e():e;return r&&$.getJSON(r.toString()).success(function(e){n(_.map(e,t))}),r});return r(),n.reload=function(){n([]),r.__value__.isValueAssigned=!1,r()},n},Snix.Types.validator=function(){var e=Snix.val({});return e.clear=function(){this({})},e.validate=function(e,t){var n={};for(var r in e)e[r].apply(t)||(n[r]=!0);return this(n),this.isEmpty()},e.field=function(e){var t=this;return{isInvalid:function(){return t.isInvalid(e)}}},e.isInvalid=function(e){return this()[e]==1},e.isEmpty=function(){return _.size(this())==0},e},Snix.Types.app=function(e){var t={};return e.apply(t,[Snix]),$(function(){Snix.Binding.binden(t,$("body")[0])}),t},Snix.Types.rest=function(e,t){var n=function(e){e=e||{};for(var n in t){var r=t[n],i=e[n]===undefined?r[1]:e[n];i!=null&&r[2]&&(i=r[2].apply(i,[i])),this[n]=r[0](i)}typeof this.init=="function"&&this.init()},r={create:[],save:[],"delete":[]};return n.prototype.on=function(e,t,n){return r[e].push(_.bind(t,n||this)),this},n.prototype.nestedUrl=function(t){return e+"/"+this.id()+"/"+t},n.prototype.delete=function(){var t=this;return Snix.delete(e+"/"+this.id()).success(function(e){_.each(r.delete,function(n){n.apply(this,[null,e,t])})}).error(function(){_.each(r.delete,function(e){e.apply(this,[!0])})}),this},n.prototype.create=function(){var n=this;return Snix.post(e,_.omit(_.pick(this,_.keys(t)),"id")).success(function(e){_.each(r.create,function(t){t.apply(this,[null,e,n])})}).error(function(){_.each(r.create,function(e){e.apply(this,[!0])})}),this},n.prototype.save=function(){var n=this;return Snix.put(e+"/"+this.id(),_.omit(_.pick(this,_.keys(t)),"id")).success(function(e){_.each(r.save,function(t){t.apply(this,[null,e,n])})}).error(function(){_.each(r.save,function(e){e.apply(this,[!0])})}),this},n},Snix.hasMany=function(e,t,n,r){e[n]=s.array();var i=!1;e.id.subscribe(function(e){if(e!=null&&!i){i=!0;var o=this.nestedUrl(n),u=function(e,r,i){if(e)return alert(t+" - delete failed");this[n].remove(i)},a="create"+t[0].toUpperCase()+t.substring(1);this[a]=r(o).on("create",function(e,t,i){if(e)return alert(a+" - create failed");this[n].add(r(o,t).on("delete",u,this))},this),s.get(o).success(function(e){this[n](_.map(e,function(e){return r(o,e).on("delete",u,this)},this))},this)}},e)},Snix.Types.model=function(e){return function(t){t=t||{};for(var n in e){var r=e[n],i=t[n]===undefined?r[1]:t[n];i!=null&&r[2]&&(i=r[2].apply(i,[i])),this[n]=r[0](i)}typeof this.init=="function"&&this.init()}},_.each(Snix.Types,function(e,t){Snix[t]=e}),typeof window=="undefined"&&(module.exports=Snix);// --------------------------------
// Snix.Binding
// --------------------------------
Snix.Binding={},Snix.Binding.parse=function(e){return _.map(e.split(";"),function(e){var t=e.indexOf(":"),n=e.substring(0,t).replace(/\s/g,""),r=e.substring(t+1,e.length).replace(/^(\s)*/g,"");return[n,r]})},Snix.Binding.accessor=function(e,t,n){return e=e.replace(/@/g,"this."),function(){try{return arguments.length==0?(new Function(_.keys(n),"return "+e)).apply(t,_.values(n)):(new Function(_.keys(n).concat(["value"]),e+"(value);")).apply(t,_.values(n).concat([arguments[0]]))}catch(r){throw window.console&&window.console.error(r,e,t,n),"expr: "+e+", err: "+r}}},Snix.Binding.binden=function(e,t,n){n=_.extend({},window,arguments.length>2?n:{}),_.each($(t).toArray(),function(t){var r=$(t).attr("data-bind");if(r){var i=Snix.Binding.parse(r);_.each(i,function(r){var i=r[0],s=r[1],o=Snix.Binding.accessor(s,e,n),u=Snix.Bindings[i];if(!u)throw"unknown binding: "+i;var a={context:e,vars:n};u.init&&u.init.apply(a,[t,o]);if(u.update){var f=Snix.compute(function(){return u.update.apply(a,[t,o]),null},this);$(t).on("destroyed",function(){f.dispose(!0)}),f()}})}else $(t).children().each(function(){Snix.Binding.binden(e,this,n)})})},Snix.Bindings={},Snix.Bindings.check={init:function(e,t){$(e).on("change",function(){t($(e).is(":checked"))})},update:function(e,t){Snix.unwrap(t())?$(e).attr("checked","checked"):$(e).removeAttr("checked")}},Snix.Bindings.click={init:function(e,t){$(e).on("click",function(e){e.preventDefault(),t()})}},Snix.Bindings.css={update:function(e,t){var n=Snix.unwrap(t());for(var r in n)n[r]?$(e).addClass(r):$(e).removeClass(r)}},Snix.Bindings.style={update:function(e,t){var n=Snix.unwrap(t());for(var r in n)n[r]?$(e).css(r,n[r]):$(e).css(r,"")}},Snix.Bindings.error={update:function(e,t){var n=Snix.unwrap(t());n.isInvalid()?$(e).addClass("error"):$(e).removeClass("error")}},function(){Snix.Bindings.date={init:function(e,t){var n=Snix.unwrap(t());n.caption=n.caption||{year:"Year",month:"Month",day:"Day"},$(e).empty();var r=moment(),i=[["year",r.year()-80,r.year()+10,n.caption.year],["month",1,12,n.caption.month],["day",1,31,n.caption.day]];_.each(i,function(t){var r=$("<select class='"+t[0]+"'></select>");r.append("<option value='-1'>"+t[3]+"</option>");for(var i=t[1];i<=t[2];i++){var s=i<10?"0"+i:i;$("<option value="+i+">"+s+"</option>").appendTo(r)}r.appendTo(e),$(r).on("change",function(){var t=parseInt($("select.year option:selected",e).val(),10),r=parseInt($("select.month option:selected",e).val(),10),i=parseInt($("select.day option:selected",e).val(),10);t!=-1&&r!=-1&&i!=-1?n.moment(moment(new Date(t,r-1,i)).startOf("day")):Snix.unwrap(n.moment)&&($("select option[value='-1']",e).attr("selected","selected"),n.moment(null))})})},update:function(e,t){var n=Snix.unwrap(t()),r=Snix.unwrap(n.moment);r?($("select.year option[value='"+r.year()+"']",e).attr("selected","selected"),$("select.month option[value='"+(r.month()+1)+"']",e).attr("selected","selected"),$("select.day option[value='"+r.date()+"']",e).attr("selected","selected")):$("select option[value='-1']",e).attr("selected","selected")}},Snix.Bindings.datetime={init:function(e,t){var n=Snix.unwrap(t());n.caption=n.caption||{year:"Year",month:"Month",day:"Day",hour:"hh",minute:"mm"},$(e).empty();var r=moment(),i=[["year",r.year()-80,r.year()+10,n.caption.year],["month",1,12,n.caption.month],["day",1,31,n.caption.day],["hour",0,23,n.caption.hour],["minute",0,59,n.caption.minute]];_.each(i,function(t){var r=$("<select class='"+t[0]+"'></select>");r.append("<option value='-1'>"+t[3]+"</option>");for(var i=t[1];i<=t[2];i++){var s=i<10?"0"+i:i;$("<option value="+i+">"+s+"</option>").appendTo(r)}r.appendTo(e),$(r).on("change",function(){var t=parseInt($("select.year option:selected",e).val(),10),r=parseInt($("select.month option:selected",e).val(),10),i=parseInt($("select.day option:selected",e).val(),10),s=parseInt($("select.hour option:selected",e).val(),10),o=parseInt($("select.minute option:selected",e).val(),10);t!=-1&&r!=-1&&i!=-1&&s!=-1&&o!=-1?n.moment(moment(new Date(t,r-1,i,s,o))):Snix.unwrap(n.moment)&&($("select option[value='-1']",e).attr("selected","selected"),n.moment(null))})})},update:function(e,t){var n=Snix.unwrap(t()),r=Snix.unwrap(n.moment);r?($("select.year option[value='"+r.year()+"']",e).attr("selected","selected"),$("select.month option[value='"+(r.month()+1)+"']",e).attr("selected","selected"),$("select.day option[value='"+r.date()+"']",e).attr("selected","selected"),$("select.hour option[value='"+r.hours()+"']",e).attr("selected","selected"),$("select.minute option[value='"+r.minutes()+"']",e).attr("selected","selected")):$("select option[value='-1']",e).attr("selected","selected")}}}(),Snix.Bindings.log={update:function(e,t){window.console&&window.console.log(Snix.unwrap(t()))}},Snix.Bindings.loop={init:function(e,t){this.tpl=$(e).html(),$(e).empty()},update:function(e,t){var n=t(),r=Snix.unwrap(n.entries),i=_.map(r,function(e){var t=Snix.idOf(e);if(!t)throw"loop expects an id attribute for each entry";return t}),s=$("> [data-id]",e).map(function(){return $(this).attr("data-id")}).toArray();i.length==s.length&&i.toString()!=s.toString()&&$(e).empty();if(s.length>0){var o=_(s).chain().difference(i).map(function(e){return"[data-id='"+e+"']"}).value().join(",");$(o,e).remove()}_.each(i,function(t){if(!_.include(s,t)){var i=_.detect(r,function(e){return Snix.idOf(e)==t}),o=$(this.tpl);o.attr("data-id",t),o.appendTo(e);var u=_.defaults({},this.vars);u[n.as]=i,Snix.call(function(){Snix.Binding.binden(this.context,o,u)},null,this)}},this)}},Snix.Bindings.radio={init:function(e,t){var n=t();$(e).on("change",function(){var e=$(this).attr("data-id");n.selected(_.detect(Snix.unwrap(n.entries),function(t){return Snix.idOf(t)==e}))}),$(e).attr("data-id",Snix.idOf(n.entry))},update:function(e,t){var n=t(),r=Snix.unwrap(n.selected);r?$(e).parents("form").find("input[name='"+$(e).attr("name")+"'][data-id='"+Snix.idOf(r)+"']").attr("checked","checked"):$(e).parents("form").find("input[name='"+$(e).attr("name")+"']").removeAttr("checked")}},Snix.Bindings.radioset={init:function(e,t){var n=t();$(e).addClass("snix").addClass("radioset"),this.tpl="<ul>";var r="snix_"+_.uniqueId();_.each(n.entries(),function(e){this.tpl+="<li>",this.tpl+="<input type='radio' name='"+r+"' data-bind=\"radio: {entries: entries(), selected: selected, entry: entries('"+e.toString()+"')}\" />",this.tpl+="<label>"+e.toString()+"</label>",this.tpl+="</li>"},this),this.tpl+="</ul>"},update:function(e,t){var n=t();$(e).empty();var r=$(this.tpl);r.appendTo(e);var i=_.defaults({},this.vars);i.entries=n.entries,i.selected=n.selected,Snix.call(function(){Snix.Binding.binden(this.context,r,i)},null,this)}},Snix.Bindings.select={init:function(e,t){var n=t();n.multiple&&$(e).attr("multiple","multiple"),$(e).on("change",function(){if(n.multiple){var t=_.map($("option:selected",e).toArray(),function(e){return $(e).attr("value")});t.length==0?n.selected([]):n.selected(_.select(Snix.unwrap(n.entries),function(e){return _.include(t,Snix.idOf(e))}))}else{var r=$("option:selected",e).attr("value");r=="-1"?n.selected(null):n.selected(_.detect(Snix.unwrap(n.entries),function(e){return Snix.idOf(e)==r}))}})},update:function(e,t){var n=t();$(e).empty();if(!n.multiple){var r=Snix.unwrap(n.caption)||"Please Choose";$("<option value='-1'>"+r+"</option>").appendTo(e)}var i=Snix.unwrap(n.label);_.each(Snix.unwrap(n.entries),function(t){var n=i?Snix.unwrap(t[i]):t.toString();$("<option value='"+Snix.idOf(t)+"'>"+n+"</option>").appendTo(e)});var s=Snix.unwrap(n.selected);n.multiple?s&&_.each(s,function(t){$("option[value='"+Snix.idOf(t)+"']",e).attr("selected","selected")}):s?$("option[value='"+Snix.idOf(s)+"']",e).attr("selected","selected"):$("option[value='-1']",e).attr("selected","selected")}},Snix.Bindings.text={update:function(e,t){$(e).text(Snix.unwrap(t()))}},Snix.Bindings.html={update:function(e,t){$(e).html(Snix.unwrap(t()))}},Snix.Bindings.on={init:function(e,t){var n=t(),r=this;for(var i in n)$(e).on(i,function(){n[i].apply(r.context,[this])})}},Snix.Bindings.toggle={init:function(e,t){this.tpl=$(e).html()},update:function(e,t){if(Snix.unwrap(t())){$(e).empty().show();var n=$(this.tpl);n.appendTo(e);var r=_.defaults({},this.vars);Snix.call(function(){Snix.Binding.binden(this.context,n,r)},null,this)}else $(e).hide().empty()}},Snix.Bindings.visible={update:function(e,t){$(e).toggle(Snix.unwrap(t())==1)}},Snix.Bindings.upload={init:function(e,t){var n=t();$(e).attr("name","file").attr("data-url",Snix.unwrap(n.url)).fileupload({dataType:"json",done:n.done||function(){}})}},Snix.Bindings.value={init:function(e,t){$(e).on("change",function(){t($(this).val())})},update:function(e,t){$(e).val(Snix.unwrap(t()))}};// --------------------------------
// Snix.Ajax
// --------------------------------
(function(){var e=function(e){return{success:function(t,n){return e.success(_.bind(t,n||this)),this},error:function(t,n){return e.error(_.bind(t,n||this)),this}}};Snix.get=function(t){var n=$.ajax({type:"GET",url:t});return e(n)},Snix.post=function(t,n,r){var n=JSON.stringify(n?n:{}),i=$.ajax({type:"POST",url:t,data:r?{data:n}:n,dataType:"json"});return e(i)},Snix.put=function(t,n){var n=JSON.stringify(n?n:{}),r=$.ajax({type:"POST",url:t,data:{data:n,_method:"PUT"},dataType:"json"});return e(r)},Snix.patch=function(t,n){var n=JSON.stringify(n?n:{}),r=$.ajax({type:"POST",url:t,data:{data:n,_method:"PATCH"},dataType:"json"});return e(r)},Snix.delete=function(t,n){var r=$.ajax({type:"POST",url:t,data:{_method:"DELETE"}});return e(r)}})();Snix.Record=function(e,t){var n={},r=function(r,i){this.id=s.val(),console.info(r),this.canCreate=s.compute(function(){return this.id()==null},this),this.canSave=s.compute(function(){return this.id()!=null},this),this.canDelete=s.compute(function(){return this.id()!=null},this),this.url=s.compute(function(){return(i!=null?i.url():"")+e+"/"+this.id()},this);var o={create:[],save:[],"delete":[]};this.on=function(e,t,n){o[e].push(_.bind(t,n||this))};var u=_.keys(t);this.delete=function(){return s.delete(this.url()).success(function(){_.invoke(o["delete"],"call",null)}).error(function(e){alert(e)}),this},this.save=function(){return s.put(this.url(),_.pick(this,u)).success(function(){_.invoke(o.save,"call",null)}).error(function(e){alert(e)}),this},this.create=function(){return s.post(this.url(),_.pick(this,this.attributes)).success(function(e){this.id(e.id),_.invoke(o.create,"call",null)},this).error(function(e){alert(e)}),this},r=r||{},r.id&&this.id(r.id);for(var a in t){var f=t[a],l=r[a]===undefined?f[1]:r[a];l!=null&&f[2]&&(l=f[2].apply(l,[l])),this[a]=f[0](l)}for(var a in n){var c=n[a];this[a]=s.array();var h=this;this[a].load=function(){return s.get(h.url()+c.baseUrl).success(function(e){h[a](_.map(e,function(e){return new c(e,h)}))},this).error(function(e){alert("err: "+e)}),this},this[a].reload=function(){return this([]),this.load()}}};return r.all=function(t){var n=s.array();return n.load=function(){var t=this;return s.get(e).success(function(e){t(_.map(e,function(e){return new r(e)}))}).error(function(e){alert("err: "+e)}),this},n.reload=function(){return this([]),this.load()},t||n.load(),n},r.find=function(t){var n=s.val();return n.load=function(){var t=this;return s.get(e).success(function(e){t(new r(e))}).error(function(e){alert("err: "+e)}),this},n.reload=function(){return this(null),this.load()},n.load(),n},r.hasMany=function(e,t){n[e]=t},r.baseUrl=e,r};
// --------------------------------
// Snix.Binding
// --------------------------------
Snix.Binding={},Snix.Binding.parse=function(e){return _.map(e.split(";"),function(e){var t=e.indexOf(":"),n=e.substring(0,t).replace(/\s/g,""),r=e.substring(t+1,e.length).replace(/^(\s)*/g,"");return[n,r]})},Snix.Binding.accessor=function(e,t,n){return e=e.replace(/@/g,"this."),function(){try{return arguments.length==0?(new Function(_.keys(n),"return "+e)).apply(t,_.values(n)):(new Function(_.keys(n).concat(["value"]),e+"(value);")).apply(t,_.values(n).concat([arguments[0]]))}catch(r){throw window.console&&window.console.error(r,e,t,n),"expr: "+e+", err: "+r}}},Snix.Binding.binden=function(e,t,n){n=_.extend({},window,arguments.length>2?n:{}),_.each($(t).toArray(),function(t){var r=$(t).attr("data-bind");if(r){var i=Snix.Binding.parse(r);_.each(i,function(r){var i=r[0],s=r[1],o=Snix.Binding.accessor(s,e,n),u=Snix.Bindings[i];if(!u)throw"unknown binding: "+i;var a={context:e,vars:n};u.init&&u.init.apply(a,[t,o]);if(u.update){var f=Snix.compute(function(){return u.update.apply(a,[t,o]),null},this);$(t).on("destroyed",function(){f.dispose(!0)}),f()}})}else $(t).children().each(function(){Snix.Binding.binden(e,this,n)})})},Snix.Bindings={},Snix.Bindings.check={init:function(e,t){$(e).on("change",function(){t($(e).is(":checked"))})},update:function(e,t){Snix.unwrap(t())?$(e).attr("checked","checked"):$(e).removeAttr("checked")}},Snix.Bindings.click={init:function(e,t){$(e).on("click",function(e){e.preventDefault(),t()})}},Snix.Bindings.css={update:function(e,t){var n=Snix.unwrap(t());for(var r in n)n[r]?$(e).addClass(r):$(e).removeClass(r)}},Snix.Bindings.style={update:function(e,t){var n=Snix.unwrap(t());for(var r in n)n[r]?$(e).css(r,n[r]):$(e).css(r,"")}},Snix.Bindings.error={update:function(e,t){var n=Snix.unwrap(t());n.isInvalid()?$(e).addClass("error"):$(e).removeClass("error")}},function(){Snix.Bindings.date={init:function(e,t){var n=Snix.unwrap(t());n.caption=n.caption||{year:"Year",month:"Month",day:"Day"},$(e).empty();var r=moment(),i=[["year",r.year()-80,r.year()+10,n.caption.year],["month",1,12,n.caption.month],["day",1,31,n.caption.day]];_.each(i,function(t){var r=$("<select class='"+t[0]+"'></select>");r.append("<option value='-1'>"+t[3]+"</option>");for(var i=t[1];i<=t[2];i++){var s=i<10?"0"+i:i;$("<option value="+i+">"+s+"</option>").appendTo(r)}r.appendTo(e),$(r).on("change",function(){var t=parseInt($("select.year option:selected",e).val(),10),r=parseInt($("select.month option:selected",e).val(),10),i=parseInt($("select.day option:selected",e).val(),10);t!=-1&&r!=-1&&i!=-1?n.moment(moment(new Date(t,r-1,i)).startOf("day")):Snix.unwrap(n.moment)&&($("select option[value='-1']",e).attr("selected","selected"),n.moment(null))})})},update:function(e,t){var n=Snix.unwrap(t()),r=Snix.unwrap(n.moment);r?($("select.year option[value='"+r.year()+"']",e).attr("selected","selected"),$("select.month option[value='"+(r.month()+1)+"']",e).attr("selected","selected"),$("select.day option[value='"+r.date()+"']",e).attr("selected","selected")):$("select option[value='-1']",e).attr("selected","selected")}},Snix.Bindings.datetime={init:function(e,t){var n=Snix.unwrap(t());n.caption=n.caption||{year:"Year",month:"Month",day:"Day",hour:"hh",minute:"mm"},$(e).empty();var r=moment(),i=[["year",r.year()-80,r.year()+10,n.caption.year],["month",1,12,n.caption.month],["day",1,31,n.caption.day],["hour",0,23,n.caption.hour],["minute",0,59,n.caption.minute]];_.each(i,function(t){var r=$("<select class='"+t[0]+"'></select>");r.append("<option value='-1'>"+t[3]+"</option>");for(var i=t[1];i<=t[2];i++){var s=i<10?"0"+i:i;$("<option value="+i+">"+s+"</option>").appendTo(r)}r.appendTo(e),$(r).on("change",function(){var t=parseInt($("select.year option:selected",e).val(),10),r=parseInt($("select.month option:selected",e).val(),10),i=parseInt($("select.day option:selected",e).val(),10),s=parseInt($("select.hour option:selected",e).val(),10),o=parseInt($("select.minute option:selected",e).val(),10);t!=-1&&r!=-1&&i!=-1&&s!=-1&&o!=-1?n.moment(moment(new Date(t,r-1,i,s,o))):Snix.unwrap(n.moment)&&($("select option[value='-1']",e).attr("selected","selected"),n.moment(null))})})},update:function(e,t){var n=Snix.unwrap(t()),r=Snix.unwrap(n.moment);r?($("select.year option[value='"+r.year()+"']",e).attr("selected","selected"),$("select.month option[value='"+(r.month()+1)+"']",e).attr("selected","selected"),$("select.day option[value='"+r.date()+"']",e).attr("selected","selected"),$("select.hour option[value='"+r.hours()+"']",e).attr("selected","selected"),$("select.minute option[value='"+r.minutes()+"']",e).attr("selected","selected")):$("select option[value='-1']",e).attr("selected","selected")}}}(),Snix.Bindings.log={update:function(e,t){window.console&&window.console.log(Snix.unwrap(t()))}},Snix.Bindings.loop={init:function(e,t){this.tpl=$(e).html(),$(e).empty()},update:function(e,t){var n=t(),r=Snix.unwrap(n.entries),i=_.map(r,function(e){var t=Snix.idOf(e);if(!t)throw"loop expects an id attribute for each entry";return t}),s=$("> [data-id]",e).map(function(){return $(this).attr("data-id")}).toArray();i.length==s.length&&i.toString()!=s.toString()&&$(e).empty();if(s.length>0){var o=_(s).chain().difference(i).map(function(e){return"[data-id='"+e+"']"}).value().join(",");$(o,e).remove()}_.each(i,function(t){if(!_.include(s,t)){var i=_.detect(r,function(e){return Snix.idOf(e)==t}),o=$(this.tpl);o.attr("data-id",t),o.appendTo(e);var u=_.defaults({},this.vars);u[n.as]=i,Snix.call(function(){Snix.Binding.binden(this.context,o,u)},null,this)}},this)}},Snix.Bindings.radio={init:function(e,t){var n=t();$(e).on("change",function(){var e=$(this).attr("data-id");n.selected(_.detect(Snix.unwrap(n.entries),function(t){return Snix.idOf(t)==e}))}),$(e).attr("data-id",Snix.idOf(n.entry))},update:function(e,t){var n=t(),r=Snix.unwrap(n.selected);r?$(e).parents("form").find("input[name='"+$(e).attr("name")+"'][data-id='"+Snix.idOf(r)+"']").attr("checked","checked"):$(e).parents("form").find("input[name='"+$(e).attr("name")+"']").removeAttr("checked")}},Snix.Bindings.radioset={init:function(e,t){var n=t();$(e).addClass("snix").addClass("radioset"),this.tpl="<ul>";var r="snix_"+_.uniqueId();_.each(n.entries(),function(e){this.tpl+="<li>",this.tpl+="<input type='radio' name='"+r+"' data-bind=\"radio: {entries: entries(), selected: selected, entry: entries('"+e.toString()+"')}\" />",this.tpl+="<label>"+e.toString()+"</label>",this.tpl+="</li>"},this),this.tpl+="</ul>"},update:function(e,t){var n=t();$(e).empty();var r=$(this.tpl);r.appendTo(e);var i=_.defaults({},this.vars);i.entries=n.entries,i.selected=n.selected,Snix.call(function(){Snix.Binding.binden(this.context,r,i)},null,this)}},Snix.Bindings.select={init:function(e,t){var n=t();n.multiple&&$(e).attr("multiple","multiple"),$(e).on("change",function(){if(n.multiple){var t=_.map($("option:selected",e).toArray(),function(e){return $(e).attr("value")});t.length==0?n.selected([]):n.selected(_.select(Snix.unwrap(n.entries),function(e){return _.include(t,Snix.idOf(e))}))}else{var r=$("option:selected",e).attr("value");r=="-1"?n.selected(null):n.selected(_.detect(Snix.unwrap(n.entries),function(e){return Snix.idOf(e)==r}))}})},update:function(e,t){var n=t();$(e).empty();if(!n.multiple){var r=Snix.unwrap(n.caption)||"Please Choose";$("<option value='-1'>"+r+"</option>").appendTo(e)}var i=Snix.unwrap(n.label);_.each(Snix.unwrap(n.entries),function(t){var n=i?Snix.unwrap(t[i]):t.toString();$("<option value='"+Snix.idOf(t)+"'>"+n+"</option>").appendTo(e)});var s=Snix.unwrap(n.selected);n.multiple?s&&_.each(s,function(t){$("option[value='"+Snix.idOf(t)+"']",e).attr("selected","selected")}):s?$("option[value='"+Snix.idOf(s)+"']",e).attr("selected","selected"):$("option[value='-1']",e).attr("selected","selected")}},Snix.Bindings.text={update:function(e,t){$(e).text(Snix.unwrap(t()))}},Snix.Bindings.html={update:function(e,t){$(e).html(Snix.unwrap(t()))}},Snix.Bindings.on={init:function(e,t){var n=t(),r=this;for(var i in n)$(e).on(i,function(){n[i].apply(r.context,[this])})}},Snix.Bindings.toggle={init:function(e,t){this.tpl=$(e).html()},update:function(e,t){if(Snix.unwrap(t())){$(e).empty().show();var n=$(this.tpl);n.appendTo(e);var r=_.defaults({},this.vars);Snix.call(function(){Snix.Binding.binden(this.context,n,r)},null,this)}else $(e).hide().empty()}},Snix.Bindings.visible={update:function(e,t){$(e).toggle(Snix.unwrap(t())==1)}},Snix.Bindings.upload={init:function(e,t){var n=t();$(e).attr("name","file").attr("data-url",Snix.unwrap(n.url)).fileupload({dataType:"json",done:n.done||function(){}})}},Snix.Bindings.value={init:function(e,t){$(e).on("change",function(){t($(this).val())})},update:function(e,t){$(e).val(Snix.unwrap(t()))}};
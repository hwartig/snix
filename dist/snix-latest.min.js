"use strict";if(typeof window=="undefined")var _=require("underscore")._;var Snix={};(function(){if(typeof jQuery!="undefined"){var e=jQuery.cleanData;jQuery.cleanData=function(t){for(var n=0,r;(r=t[n])!==undefined;n++)jQuery(r).triggerHandler("destroyed");e(t)}}})(),Snix.idOf=function(e){return(typeof e=="string"||typeof e=="number"?e:Snix.unwrap(e.id)).toString()},Snix.call=function(e,t,n){var r=Snix.__caller__;Snix.__caller__=t,e.apply(n),Snix.__caller__=r},Snix.__caller__=null,Snix.unwrap=function(e){return e&&e.__snix__?this.unwrap(e()):e},function(){var e=function(t,n,r){r=r||[];if(t==null||_.include(r,t))return null;switch(typeof t){case"number":case"date":case"string":case"function":case"boolean":return t;case"object":r.push(t);if(t instanceof Array)for(var i=0;i<t.length;i++)t[i]=e(t[i],n,r);else for(var s in t){var o=t[s];delete t[s],t[n(s)]=e(o,n,r)}return t}};Snix.toCamelCase=function(t){return e(t,function(e){return e.replace(/(_[a-z])/g,function(e){return e.toUpperCase().replace("_","")})})},Snix.toUnderscore=function(t){return e(t,function(e){return e.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()})})}}(),Snix.useGC=!1,Snix.logGC=!1,Snix.objectCnt=0,Snix.Value=function(e){console.info("-------- NEW");if(arguments.length==0||e===undefined)throw"missing valueProvider";var t=this,n=function(){if(!t.isDisposed){console.info("GC ["+t.id+"]");var e=t.dependants.length;t.dependants=_.reject(t.dependants,function(e){return e.isDisposed}),Snix.logGC&&t.dependants.length!=e&&console.info("snix gc["+t.id+"]: "+(e-t.dependants.length)),setTimeout(n,3e3)}};Snix.useGC&&setTimeout(n,3e3),this.id=_.uniqueId(),this.dependants=[],this.isValueAssigned=!1,this.value=null,this.valueProvider=e,this.isDisposed=!1,this.dispose=function(){this.isDisposed=!0,Snix.objectCnt--,_.each(this.dependants,function(e){e.isDisposed||e.dispose()}),this.dependants=[],this.dependants=null,this.isValueAssigned=null,this.value=null,this.valueProvider=null,this.get=function(){throw"disposed"},this.set=function(){throw"disposed"}},this.triggerDependants=function(){var e=[this],t=null;while(t=e.splice(0,1)[0]){t.dependants=_.reject(t.dependants,function(e){return e.isDisposed==1});for(var n=0;n<t.dependants.length;n++){var r=t.dependants[n];if(r==Snix.__caller__)continue;var i=r.valueProvider,s=i();s!==r.value&&(r.value=s,e.push(r))}}},this.convert=function(e){return e},this.set=function(e){e=this.convert(e),this.value!==e&&(this.value=e,this.isValueAssigned=!0,this.triggerDependants())},this.provideValue=function(){return typeof this.valueProvider=="function"?this.valueProvider():this.valueProvider},this.trackCaller=function(){Snix.__caller__&&(_.include(this.dependants,Snix.__caller__)||this.dependants.push(Snix.__caller__))},this.get=function(){return this.trackCaller(),this.isValueAssigned||(this.isValueAssigned=!0,this.set(this.provideValue())),this.value},this.fun=function(){var e=this,t=function(){return arguments.length==0?e.get():(e.set(arguments[0]),t)};t.__value__=this,t.dispose=function(){e.dispose.apply(e,arguments)},t.__snix__=!0,t.toJSON=function(){var t=e.get();return t&&t.toJSON?t.toJSON():t};var n=[];return t.subscribe=function(t,r){var i=Snix.compute(function(){var n=e.get();Snix.call(function(){t.apply(r,[n])},null,r)});return n.push([t,i]),i(),this},t.unsubscribe=function(e){var t=_.detect(n,function(t){return t[0]==e});return t[1].dispose(),n=_.without(n,t),this},Snix.objectCnt++,t}},Snix.Types={},Snix.Types.val=function(e){e=arguments.length>0?e:null;var t=new Snix.Value(e);return t.fun()},Snix.Types.boolean=function(e){var t=new Snix.Value(e);return t.convert=function(e){return e==null?null:e==1||e=="true"||e=="yes"},t.fun()},Snix.Types.int=function(e){var t=new Snix.Value(e);return t.convert=function(e){return e==null?null:parseInt(e,10)},t.fun()},Snix.Types.float=function(e){var t=new Snix.Value(e);return t.convert=function(e){return e==null?null:parseFloat(e)},t.fun()},Snix.Types.moment=function(e){var t=new Snix.Value(e),n=t.fun();return n.toJSON=function(){var e=t.get();return e==null?null:(e=e.toDate(),e&&e.toJSON?e.toJSON():e)},n},Snix.Types.array=function(e){e=arguments.length>0?e:[];if(!_.isArray(e))throw"not an array";var t=new Snix.Value(e);t.convert=function(e){if(!_.isArray(e))throw"not an array";return e};var n=t.fun();return n.add=function(e){var n=t.get();n.push(e),t.triggerDependants()},n.remove=function(e){var n=t.get(),r=_.without(n,e);t.set(r)},n.size=function(){return t.get().length},n.clear=function(){t.set([])},n.isEmpty=function(){return t.get().length==0},n},Snix.Types.compute=function(e,t,n){t=t||this,n=_.defaults(n||{},{});var r=_.bind(e,t),i=function(){try{var e=Snix.__caller__;return Snix.__caller__=s,r()}finally{Snix.__caller__=e}},s=new Snix.Value(i);return s.fun()},Snix.Types.enu=function(){var e=[];for(var t=0;t<arguments.length;t++){var n={id:t,name:arguments[t].toString()};n.toJSON=function(){return this.name},n.toString=function(){return this.name},e.push(n)}var r=function(){if(arguments.length==0)return e;var t=_.where(e,{name:arguments[0].toString()})[0];if(!t)throw"unknown in enumeration: "+arguments[0].toString();return t};return r},Snix.Types.remote=function(e,t){var n=Snix.val(null);t=arguments.length>1?t:function(e){return e};var r=Snix.compute(function(){var r=typeof e=="function"?e():e;return r&&$.getJSON(r.toString()).success(function(e){n(t(e))}),r});return r(),n.reload=function(){n(null),r.__value__.isValueAssigned=!1,r()},n},Snix.Types.remoteArray=function(e,t){var n=Snix.array();t=arguments.length>1?t:function(e){return e};var r=Snix.compute(function(){var r=typeof e=="function"?e():e;return r&&$.getJSON(r.toString()).success(function(e){n(_.map(e,t))}),r});return r(),n.reload=function(){n([]),r.__value__.isValueAssigned=!1,r()},n},Snix.Types.validator=function(){var e=Snix.val({});return e.clear=function(){this({})},e.validate=function(e,t){var n={};for(var r in e)e[r].apply(t)||(n[r]=!0);return this(n),this.isEmpty()},e.field=function(e){var t=this;return{isInvalid:function(){return t.isInvalid(e)}}},e.isInvalid=function(e){return this()[e]==1},e.isEmpty=function(){return _.size(this())==0},e},Snix.Types.app=function(e){var t={};return e.apply(t,[Snix]),$(function(){Snix.Binding.binden(t,$("body")[0])}),t},Snix.Types.rest=function(e,t){var n=function(e){e=e||{};for(var n in t){var r=t[n],i=e[n]===undefined?r[1]:e[n];i!=null&&r[2]&&(i=r[2].apply(i,[i])),this[n]=r[0](i)}typeof this.init=="function"&&this.init()},r={create:[],save:[],"delete":[]};return n.prototype.on=function(e,t,n){return r[e].push(_.bind(t,n||this)),this},n.prototype.nestedUrl=function(t){return e+"/"+this.id()+"/"+t},n.prototype.delete=function(){var t=this;return Snix.delete(e+"/"+this.id()).success(function(e){_.each(r.delete,function(n){n.apply(this,[null,e,t])})}).error(function(){_.each(r.delete,function(e){e.apply(this,[!0])})}),this},n.prototype.create=function(){var n=this;return Snix.post(e,_.omit(_.pick(this,_.keys(t)),"id")).success(function(e){_.each(r.create,function(t){t.apply(this,[null,e,n])})}).error(function(){_.each(r.create,function(e){e.apply(this,[!0])})}),this},n.prototype.save=function(){var n=this;return Snix.put(e+"/"+this.id(),_.omit(_.pick(this,_.keys(t)),"id")).success(function(e){_.each(r.save,function(t){t.apply(this,[null,e,n])})}).error(function(){_.each(r.save,function(e){e.apply(this,[!0])})}),this},n},Snix.hasMany=function(e,t,n,r){e[n]=s.array();var i=!1;e.id.subscribe(function(e){if(e!=null&&!i){i=!0;var o=this.nestedUrl(n),u=function(e,r,i){if(e)return alert(t+" - delete failed");this[n].remove(i)},a="create"+t[0].toUpperCase()+t.substring(1);this[a]=r(o).on("create",function(e,t,i){if(e)return alert(a+" - create failed");this[n].add(r(o,t).on("delete",u,this))},this),s.get(o).success(function(e){this[n](_.map(e,function(e){return r(o,e).on("delete",u,this)},this))},this)}},e)},Snix.Types.model=function(e){return function(t){t=t||{};for(var n in e){var r=e[n],i=t[n]===undefined?r[1]:t[n];i!=null&&r[2]&&(i=r[2].apply(i,[i])),this[n]=r[0](i)}typeof this.init=="function"&&this.init()}},_.each(Snix.Types,function(e,t){Snix[t]=e}),typeof window=="undefined"&&(module.exports=Snix);